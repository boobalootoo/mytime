<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Led Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f1;
        }
        .task-item {
            position: absolute;
            width: 95%;
            left: 2.5%;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: grab;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-item:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: scale(1.02);
        }
        .task-item.dragging {
            cursor: grabbing;
            opacity: 0.7;
            transform: scale(1.05);
            z-index: 50;
        }
        .handle {
            width: 100%;
            height: 10px;
            background-color: #d1d5db;
            border-radius: 9999px;
            cursor: ns-resize;
            margin-top: 0.5rem;
            margin-bottom: -0.5rem;
        }
        .pop-up {
            z-index: 100;
        }
        .pop-up-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 99;
        }
        .overlapping {
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0.4); }
        }
        /* Hide scrollbar for a cleaner look */
        .overflow-y-scroll::-webkit-scrollbar {
            display: none;
        }
        .overflow-y-scroll {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body class="p-4 bg-fuchsia-50 text-slate-800 flex flex-col min-h-screen">

    <!-- Global App State -->
    <script>
        const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const __firebase_config = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // This is a placeholder for how you would set up Firestore.
        // For this single-file app, we'll use localStorage for persistence.
        // To use Firestore, you would uncomment the imports below and replace
        // the localStorage logic with Firestore API calls.
        /*
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId;
        
        async function initAuthAndFirestore() {
            try {
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log("Authenticated as user:", userId);
            } catch (error) {
                console.error("Firebase Auth error:", error);
            }
        }
        
        window.onload = () => {
          initAuthAndFirestore();
          // The planner's initial rendering would go here,
          // with onSnapshot() to listen for real-time updates.
        };
        */
        
    </script>

    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-indigo-900">Baby Led Planner</h1>
        <button id="myological-time-btn" class="text-sm font-semibold text-indigo-600 bg-white hover:bg-indigo-50 px-3 py-1 rounded-full shadow-md">
            What is "Myological Time"?
        </button>
    </header>

    <!-- Main Content - Planner & Control Panel -->
    <main class="flex-grow flex flex-col md:flex-row gap-6">
        
        <!-- Planner View -->
        <div class="flex flex-col md:flex-row flex-grow w-full gap-4 md:gap-6">
            <!-- Goal Day -->
            <div id="goal-day-container" class="relative bg-white rounded-xl shadow-lg p-4 flex-grow overflow-y-scroll h-full min-h-[400px] md:min-h-0">
                <h2 class="text-xl font-bold mb-4 text-emerald-600">Goal Day</h2>
                <div id="goal-day-timeline" class="relative h-[200vh]">
                    <!-- Timeline items will be rendered here dynamically -->
                </div>
            </div>

            <!-- Real Day -->
            <div id="real-day-container" class="relative bg-white rounded-xl shadow-lg p-4 flex-grow overflow-y-scroll h-full min-h-[400px] md:min-h-0">
                <h2 class="text-xl font-bold mb-4 text-pink-600">Real Day</h2>
                <div id="real-day-timeline" class="relative h-[200vh]">
                    <!-- Timeline items will be rendered here dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 w-full md:w-96 flex-shrink-0">
            <h2 class="text-2xl font-semibold mb-4 text-center text-slate-700">Add & Manage</h2>

            <!-- Task Form -->
            <form id="add-task-form" class="mb-6">
                <label for="task-name" class="block text-sm font-medium text-slate-700">Task Name</label>
                <input type="text" id="task-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 mb-2 p-2">
                
                <label for="task-duration" class="block text-sm font-medium text-slate-700">Duration (mins)</label>
                <input type="number" id="task-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                
                <label for="task-type" class="block text-sm font-medium text-slate-700 mt-4">For which day?</label>
                <select id="task-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    <option value="goal">Goal Day</option>
                    <option value="real">Real Day</option>
                </select>
                
                <button type="submit" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-105">
                    Add Task
                </button>
            </form>

            <hr class="my-6 border-slate-200">

            <!-- Settings -->
            <div>
                <h3 class="text-xl font-semibold mb-2 text-slate-700">View Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label for="time-view" class="block text-sm font-medium text-slate-700 mb-2">Show Time Markers</label>
                        <select id="time-view" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="none">No Times</option>
                            <option value="limited">Limited (e.g., Noon, Midnight)</option>
                            <option value="all">All Times</option>
                        </select>
                    </div>

                    <div>
                        <label for="buffer-minutes" class="block text-sm font-medium text-slate-700 mb-2">Default Buffer (minutes)</label>
                        <input type="number" id="buffer-minutes" value="5" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>

                    <div>
                        <label for="add-regular-times" class="flex items-center text-sm font-medium text-slate-700">
                            <input type="checkbox" id="add-regular-times" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500">
                            Add Regular Times (Meals, Naps)
                        </label>
                    </div>
                </div>
            </div>
            
            <hr class="my-6 border-slate-200">

            <!-- Social Media Share -->
            <div>
                <h3 class="text-xl font-semibold mb-2 text-slate-700">Share Availability</h3>
                <p class="text-sm text-slate-600 mb-4">Let friends know when you're available for a call or visit.</p>
                <button id="share-availability-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-105">
                    Share Status with Friends
                </button>
            </div>
        </div>
    </main>
    
    <!-- Myological Time Pop-up -->
    <div id="myological-time-modal" class="hidden fixed inset-0 flex items-center justify-center pop-up">
        <div class="absolute inset-0 pop-up-backdrop"></div>
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg z-10 mx-4">
            <h3 class="text-2xl font-bold mb-4 text-indigo-900">What is "Myological Time"?</h3>
            <p class="text-slate-700 mb-4">
                "Myological time" is a playful concept suggesting that time is not a fixed, linear measure but a fluid experience determined by our biology, or in this case, the unpredictable rhythm of a baby's needs. It acknowledges that a baby's hunger, sleep, or mood dictate the schedule, making traditional time-based planning irrelevant. This planner embraces that fluidity by focusing on tasks and sequences rather than rigid timestamps.
            </p>
            <p class="text-slate-700 mb-4">
                To dive deeper, listen to the "Time Warp" episode from the BBC Sounds podcast 'Child':
            </p>
            <a href="https://www.bbc.co.uk/sounds/series/p05c9h75" target="_blank" class="block text-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                Listen to "Time Warp"
            </a>
            <button id="close-modal-btn" class="mt-4 w-full text-sm text-slate-500 hover:text-slate-800">Close</button>
        </div>
    </div>
    
    <!-- JavaScript for Functionality -->
    <script>
        const myologicalBtn = document.getElementById('myological-time-btn');
        const myologicalModal = document.getElementById('myological-time-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addTaskForm = document.getElementById('add-task-form');
        const taskNameInput = document.getElementById('task-name');
        const taskDurationInput = document.getElementById('task-duration');
        const taskTypeSelect = document.getElementById('task-type');
        const goalDayTimeline = document.getElementById('goal-day-timeline');
        const realDayTimeline = document.getElementById('real-day-timeline');
        const timeViewSelect = document.getElementById('time-view');
        const bufferMinutesInput = document.getElementById('buffer-minutes');
        const addRegularTimesCheckbox = document.getElementById('add-regular-times');
        const shareAvailabilityBtn = document.getElementById('share-availability-btn');

        // Global state
        let tasks = [];
        let isDragging = false;
        let activeTask = null;
        let startY = 0;
        let startHeight = 0;
        let isResizing = false;

        // Local Storage for a simple demo.
        const saveState = () => {
            localStorage.setItem('plannerState', JSON.stringify(tasks));
        };
        
        const loadState = () => {
            const savedState = localStorage.getItem('plannerState');
            if (savedState) {
                tasks = JSON.parse(savedState);
            }
        };

        const renderTasks = () => {
            goalDayTimeline.innerHTML = '';
            realDayTimeline.innerHTML = '';

            const goalTasks = tasks.filter(t => t.type === 'goal').sort((a, b) => a.position - b.position);
            const realTasks = tasks.filter(t => t.type === 'real').sort((a, b) => a.position - b.position);

            const calculateTimelineHeight = (taskArray) => {
                if (taskArray.length === 0) return 0;
                const lastTask = taskArray[taskArray.length - 1];
                const endPos = lastTask.position + lastTask.height;
                // Ensure the timeline is at least 1500px tall
                return Math.max(endPos + 200, 1500); 
            };

            goalDayTimeline.style.height = `${calculateTimelineHeight(goalTasks)}px`;
            realDayTimeline.style.height = `${calculateTimelineHeight(realTasks)}px`;

            renderTimeline(goalTasks, goalDayTimeline);
            renderTimeline(realTasks, realDayTimeline);
            renderTimeMarkers();
            checkOverlap();
        };

        const renderTimeline = (taskArray, container) => {
            taskArray.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.classList.add('task-item', 'bg-white', 'hover:bg-gray-50', 'text-slate-800', 'shadow-md');
                
                if (task.type === 'goal') {
                    taskEl.classList.add('bg-emerald-100', 'hover:bg-emerald-200');
                } else {
                    taskEl.classList.add('bg-pink-100', 'hover:bg-pink-200');
                }

                taskEl.style.top = `${task.position}px`;
                taskEl.style.height = `${task.height}px`;
                taskEl.dataset.id = task.id;
                taskEl.dataset.type = task.type;

                taskEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-sm font-semibold">${task.name}</span>
                        <span class="text-xs text-slate-500">${task.duration_text}</span>
                    </div>
                    ${task.isBuffer ? '<div class="text-xs text-slate-400 mt-2">Buffer time</div>' : ''}
                    <div class="resizer handle bg-slate-300 hover:bg-slate-400 rounded-full"></div>
                `;
                
                container.appendChild(taskEl);
            });
        };

        const renderTimeMarkers = () => {
            const timeView = timeViewSelect.value;
            const containers = [goalDayTimeline, realDayTimeline];
            const now = new Date();
            const wakeUpTime = now.getHours() * 60 + now.getMinutes();

            containers.forEach(container => {
                // Clear old markers
                container.querySelectorAll('.time-marker').forEach(el => el.remove());

                let startMarker = 0;
                let endMarker = 24 * 60; // 24 hours in minutes

                const allTasks = tasks.filter(t => (t.type === 'goal' && container.id === 'goal-day-timeline') || (t.type === 'real' && container.id === 'real-day-timeline'));
                if (allTasks.length > 0) {
                    const sortedTasks = allTasks.sort((a, b) => a.position - b.position);
                    startMarker = Math.floor(sortedTasks[0].position / 10);
                    endMarker = Math.ceil((sortedTasks[sortedTasks.length - 1].position + sortedTasks[sortedTasks.length - 1].height) / 10);
                }

                for (let minute = startMarker; minute <= endMarker; minute += 60) {
                    const hour = Math.floor(minute / 60);
                    const time = `${hour % 12 === 0 ? 12 : hour % 12}:${hour < 10 ? '00' : '00'} ${hour >= 12 ? 'PM' : 'AM'}`;
                    const position = minute * 10; // 10px per minute

                    let shouldRender = false;
                    if (timeView === 'all') {
                        shouldRender = true;
                    } else if (timeView === 'limited') {
                        if (minute === 12 * 60 || minute === 0) { // Noon and midnight
                            shouldRender = true;
                        }
                    } else if (timeView === 'none') {
                        shouldRender = false;
                    }

                    // Always show the current time
                    if (Math.abs(minute - wakeUpTime) < 30) {
                       shouldRender = true;
                    }

                    if (shouldRender) {
                        const marker = document.createElement('div');
                        marker.classList.add('time-marker', 'absolute', 'left-0', 'w-full', 'border-t', 'border-dashed', 'border-slate-300', 'text-xs', '-translate-y-1/2', 'text-slate-500', 'pl-2');
                        marker.style.top = `${position}px`;
                        marker.textContent = time;
                        container.appendChild(marker);
                    }
                }
            });
        };

        const checkOverlap = () => {
            const containers = [goalDayTimeline, realDayTimeline];
            const tasksWithElements = [];
            containers.forEach(container => {
                container.querySelectorAll('.task-item').forEach(el => {
                    const id = el.dataset.id;
                    const task = tasks.find(t => t.id === id);
                    tasksWithElements.push({ el, task });
                    el.classList.remove('overlapping');
                });
            });

            for (let i = 0; i < tasksWithElements.length; i++) {
                for (let j = i + 1; j < tasksWithElements.length; j++) {
                    const taskA = tasksWithElements[i].task;
                    const taskB = tasksWithElements[j].task;
                    const elA = tasksWithElements[i].el;
                    const elB = tasksWithElements[j].el;

                    if (taskA.type === taskB.type) {
                        // Check for overlap based on position and height
                        const topA = taskA.position;
                        const bottomA = topA + taskA.height;
                        const topB = taskB.position;
                        const bottomB = topB + taskB.height;

                        if ((topA < bottomB && bottomA > topB) || (topB < bottomA && bottomB > topA)) {
                            elA.classList.add('overlapping');
                            elB.classList.add('overlapping');
                        }
                    }
                }
            }
        };

        const updateTaskPosition = (taskId, newPosition) => {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.position = Math.max(0, newPosition);
                saveState();
                renderTasks();
            }
        };

        const updateTaskHeight = (taskId, newHeight) => {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.height = Math.max(30, newHeight); // Minimum height
                task.duration = Math.round(newHeight / 10);
                tas
